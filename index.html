<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Syna Search & Solemate</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            height: 100vh; width: 100vw; overflow: hidden;
            color: white; background-color: #0f0f0f; position: relative;
        }

        /* --- –§–û–ù: –¢–û–¢ –°–ê–ú–´–ô –ì–†–ê–î–ò–ï–ù–¢ --- */
        .background-effect {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: -2;
            background: linear-gradient(-45deg, #0d0d0d, #1a0b2e, #0f2027, #203a43);
            background-size: 400% 400%;
            animation: gradientBG 15s ease infinite;
        }
        @keyframes gradientBG {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* –°–ù–ï–ì */
        #snow-container {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; z-index: -1; overflow: hidden;
        }
        .snowflake {
            position: absolute; top: -10px; background: white; border-radius: 50%;
            opacity: 0.8; filter: blur(1px);
        }
        @keyframes fall {
            0% { transform: translateY(-10vh) translateX(0); }
            100% { transform: translateY(110vh) translateX(20px); }
        }

        /* –ö–û–ù–¢–ï–ù–¢ */
        .main-content-wrapper {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; justify-content: center; align-items: center; flex-direction: column;
            transition: transform 0.6s cubic-bezier(0.22, 1, 0.36, 1); z-index: 1;
        }
        @media (min-width: 769px) {
            .main-content-wrapper.shifted { transform: translateX(-25%); }
        }

        .search-container { text-align: center; width: 100%; max-width: 600px; padding: 20px; display: flex; flex-direction: column; align-items: center; position: relative; }
        h1 {
            font-size: 80px; font-weight: 300; letter-spacing: 4px; margin-bottom: 30px;
            background: -webkit-linear-gradient(45deg, #fff, #a8c0ff); -webkit-background-clip: text;
            -webkit-text-fill-color: transparent; text-shadow: 0 0 20px rgba(168, 192, 255, 0.3);
            animation: float 6s ease-in-out infinite;
        }
        @keyframes float { 0% { transform: translateY(0px); } 50% { transform: translateY(-10px); } 100% { transform: translateY(0px); } }
        
        /* –ò–ù–ü–£–¢ */
        .input-wrapper {
            position: relative; width: 100%; max-width: 500px; overflow: visible;
            border-radius: 50px; display: flex; align-items: center;
            background: rgba(255, 255, 255, 0.05); border: 2px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px); transition: border 0.3s ease, box-shadow 0.3s ease;
            z-index: 20;
        }
        .input-wrapper:focus-within { border-color: rgba(168, 192, 255, 0.5); box-shadow: 0 0 25px rgba(168, 192, 255, 0.3); }
        .input-inner {
            width: 100%; height: 100%; border-radius: 50px; overflow: hidden; position: relative; display: flex; align-items: center;
        }
        .custom-input {
            width: 100%; padding: 18px 125px 18px 30px; border: none; background: transparent;
            color: #fff; font-size: 18px; outline: none; caret-color: transparent;
        }
        
        /* –ü–û–î–°–ö–ê–ó–ö–ò */
        .suggestions-box {
            position: absolute; top: 100%; left: 20px; right: 20px; margin-top: 10px;
            background: rgba(15, 15, 30, 0.95); backdrop-filter: blur(15px);
            border-radius: 20px; border: 1px solid rgba(255,255,255,0.1);
            overflow: hidden; display: none; flex-direction: column;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5); z-index: 15;
            text-align: left; opacity: 0; transform: translateY(-10px);
            transition: opacity 0.3s, transform 0.3s;
        }
        .suggestions-box.active { display: flex; opacity: 1; transform: translateY(0); }
        .suggestion-item {
            padding: 12px 25px; cursor: pointer; color: #ccc; font-size: 16px;
            transition: 0.2s; border-bottom: 1px solid rgba(255,255,255,0.05);
            display: flex; align-items: center; gap: 10px;
        }
        .suggestion-item:last-child { border-bottom: none; }
        .suggestion-item:hover { background: rgba(168, 192, 255, 0.1); color: white; padding-left: 30px; }
        .suggestion-icon { font-size: 12px; opacity: 0.5; }
        
        /* –ö–ù–û–ü–ö–ò –í–ù–£–¢–†–ò */
        .input-icon-btn {
            position: absolute; background: none; border: none; cursor: pointer;
            width: 30px; height: 30px; display: flex; justify-content: center; align-items: center;
            border-radius: 50%; transition: all 0.3s ease; z-index: 10;
        }
        .input-icon-btn svg { width: 20px; height: 20px; fill: #a8c0ff; transition: fill 0.2s; }
        .input-icon-btn:hover { background: rgba(255,255,255,0.1); }
        .translate-btn { right: 90px; }
        .mic-btn { right: 55px; }
        .ai-trigger-btn {
            right: 15px; color: #a8c0ff; font-weight: 900; font-size: 18px; padding-bottom: 4px;
        }
        .ai-trigger-btn:hover {
            color: #fff; background: transparent; transform: scale(1.2);
            text-shadow: 0 0 10px #a8c0ff, 0 0 20px #764ba2, 0 0 30px #fff;
        }

        .mic-btn.listening { animation: pulse-red 1.5s infinite; }
        .mic-btn.listening svg { fill: #ff6b6b; }
        @keyframes pulse-red { 0% { box-shadow: 0 0 0 0 rgba(255, 107, 107, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(255, 107, 107, 0); } 100% { box-shadow: 0 0 0 0 rgba(255, 107, 107, 0); } }
        
        .tooltip {
            position: absolute; top: -45px; right: 40px;
            background: #ff6b6b; color: white; padding: 5px 10px; border-radius: 8px;
            font-size: 12px; font-weight: bold; pointer-events: none;
            opacity: 0; transform: translateY(10px); transition: 0.3s;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3); z-index: 30;
        }
        .tooltip::after {
            content: ''; position: absolute; bottom: -5px; right: 15px;
            border-width: 5px 5px 0; border-style: solid; border-color: #ff6b6b transparent transparent transparent;
        }
        .tooltip.show { opacity: 1; transform: translateY(0); }
        
        .smooth-caret {
            position: absolute; top: 50%; left: 30px; transform: translateY(-50%);
            width: 2px; height: 24px; background-color: #a8c0ff;
            box-shadow: 0 0 10px #a8c0ff; pointer-events: none; opacity: 0;
            transition: left 0.1s linear, opacity 0.2s ease;
        }

        /* –ò–°–¢–û–†–ò–Ø */
        .history-container { margin-top: 15px; display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; max-width: 500px; position: relative; z-index: 5; }
        .history-tag {
            background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 5px 12px; border-radius: 20px; font-size: 14px; color: #ccc;
            backdrop-filter: blur(5px); transition: 0.2s; display: flex; align-items: center; gap: 8px; cursor: pointer;
        }
        .history-tag:hover { background: rgba(255, 255, 255, 0.2); color: #fff; border-color: #a8c0ff; }
        .delete-tag { color: #ff6b6b; font-weight: bold; font-size: 16px; line-height: 1; opacity: 0.6; cursor: pointer; }
        .delete-tag:hover { opacity: 1; transform: scale(1.2); }

        /* –í–ò–î–ñ–ï–¢–´ */
        .widgets-container {
            margin-top: 25px; display: flex; justify-content: center; gap: 20px; flex-wrap: wrap; max-width: 600px; z-index: 5;
        }
        .widget-item {
            width: 60px; height: 60px; border-radius: 50%;
            background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1);
            backdrop-filter: blur(10px); display: flex; justify-content: center; align-items: center;
            cursor: pointer; transition: 0.3s; position: relative; text-decoration: none;
            overflow: hidden; 
        }
        .widget-item:hover { transform: translateY(-5px); background: rgba(255,255,255,0.15); border-color: #a8c0ff; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        .widget-item::before {
            content: ''; position: absolute; top: 0; left: -100%; width: 50%; height: 100%;
            background: linear-gradient(to right, rgba(255,255,255,0) 0%, rgba(255,255,255,0.4) 50%, rgba(255,255,255,0) 100%);
            transform: skewX(-25deg); pointer-events: none;
        }
        .widget-item:hover::before { animation: shine 0.75s; }
        @keyframes shine { 100% { left: 125%; } }
        .widget-icon { width: 32px; height: 32px; border-radius: 4px; object-fit: contain; z-index: 1; }
        .add-widget-btn { font-size: 30px; color: #a8c0ff; font-weight: 300; z-index: 1; }
        
        .ai-button {
            position: fixed; bottom: 30px; right: 30px; width: 60px; height: 60px; border-radius: 50%;
            background: linear-gradient(135deg, #667eea, #764ba2); border: none; cursor: pointer;
            box-shadow: 0 0 20px rgba(118, 75, 162, 0.5); z-index: 100; font-size: 20px; font-weight: bold; color: white;
            transition: transform 0.3s ease; display: flex; justify-content: center; align-items: center; padding-bottom: 3px;
        }
        .ai-button:hover { transform: scale(1.1) rotate(10deg); }

        /* –ß–ê–¢ */
        .chat-panel {
            position: fixed; top: 0; right: 0; width: 50%; height: 100%;
            background: rgba(15, 15, 25, 0.95); backdrop-filter: blur(25px);
            border-left: 1px solid rgba(255, 255, 255, 0.1); display: flex; flex-direction: column;
            box-shadow: -10px 0 50px rgba(0,0,0,0.5); transform: translateX(100%);
            transition: transform 0.6s cubic-bezier(0.22, 1, 0.36, 1); z-index: 99;
        }
        .chat-panel.active { transform: translateX(0); }
        .chat-header { padding: 25px; background: rgba(255,255,255,0.03); border-bottom: 1px solid rgba(255,255,255,0.05); font-size: 24px; font-weight: 300; color: #a8c0ff; display: flex; justify-content: space-between; align-items: center; }
        .chat-messages { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 15px; }
        .chat-messages::-webkit-scrollbar { width: 6px; } .chat-messages::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }
        .message { max-width: 85%; padding: 12px 18px; border-radius: 18px; font-size: 16px; line-height: 1.5; word-wrap: break-word; }
        .message.user { align-self: flex-end; background: linear-gradient(135deg, #4a69bd, #3c5091); color: white; border-bottom-right-radius: 4px; }
        .message.ai { align-self: flex-start; background: #252830; color: #ecf0f1; border-bottom-left-radius: 4px; border: 1px solid rgba(255,255,255,0.05); }
        .message.error { align-self: center; background: #c0392b; color: white; font-size: 14px; text-align: center; }
        .typing { font-style: italic; color: #888; font-size: 13px; margin: 0 20px 10px 20px; display: none; }
        .chat-input-area { padding: 20px; border-top: 1px solid rgba(255,255,255,0.05); background: rgba(0,0,0,0.2); display: flex; justify-content: center; }
        .close-btn { font-size: 24px; cursor: pointer; opacity: 0.6; transition: 0.2s; } .close-btn:hover { opacity: 1; transform: rotate(90deg); }
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); backdrop-filter: blur(5px);
            z-index: 200; display: none; justify-content: center; align-items: center;
        }
        .modal-box {
            background: rgba(20, 20, 35, 0.9); border: 1px solid rgba(255,255,255,0.1);
            padding: 30px; border-radius: 20px; width: 350px; text-align: center;
            box-shadow: 0 0 50px rgba(168, 192, 255, 0.2); position: relative;
        }
        .modal-input { width: 100%; padding: 12px; margin: 15px 0; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 10px; color: white; outline: none; }
        .modal-btn { padding: 10px 20px; background: #a8c0ff; border: none; border-radius: 10px; cursor: pointer; font-weight: bold; }

        /* –ê–î–ê–ü–¢–ò–í */
        @media screen and (max-width: 768px) {
            h1 { font-size: 50px; }
            .chat-panel { width: 100%; border-left: none; }
            .main-content-wrapper.shifted { transform: none; opacity: 0; pointer-events: none; } 
            .ai-button { display: none; } 
            .custom-input { padding-right: 110px; padding-left: 20px; }
        }
    </style>
</head>
<body>

    <div class="background-effect"></div>
    <div id="snow-container"></div>

    <div class="main-content-wrapper" id="contentWrapper">
        <div class="search-container">
            <h1>Syna</h1>
            
            <form action="https://www.google.com/search" method="get" target="_blank" onsubmit="handleSearchSubmit()" style="width:100%; display:flex; justify-content:center;">
                <div style="width: 100%; max-width: 500px; position: relative;">
                    <div class="input-wrapper" id="searchWrapper">
                        <div class="tooltip" id="transTooltip">–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç!</div>
                        <div class="input-inner">
                            <input type="text" id="searchInput" class="custom-input" name="q" placeholder="Search the web..." required autocomplete="off" oninput="handleTyping(this.value)">
                            
                            <button type="button" class="input-icon-btn translate-btn" onclick="openTranslator()" title="–ü–µ—Ä–µ–≤–µ—Å—Ç–∏">
                                <svg viewBox="0 0 24 24"><path d="M12.87 15.07l-2.54-2.51.03-.03c1.74-1.94 2.98-4.17 3.71-6.53H17V4h-7V2H8v2H1v2h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12zm-2.62 7l1.62-4.33L19.12 17h-3.24z"/></svg>
                            </button>
                            
                            <button type="button" class="input-icon-btn mic-btn" id="micBtn" onclick="startVoiceSearch()" title="–ì–æ–ª–æ—Å">
                                <svg viewBox="0 0 24 24"><path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z"/><path d="M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/></svg>
                            </button>

                            <button type="button" class="input-icon-btn ai-trigger-btn" onclick="toggleChat()" title="–û—Ç–∫—Ä—ã—Ç—å Solemate">
                                :3
                            </button>

                            <div class="smooth-caret"></div>
                        </div>
                    </div>
                    <div class="suggestions-box" id="suggestionsBox"></div>
                </div>
            </form>

            <div id="searchHistory" class="history-container"></div>
            
            <div id="widgetsContainer" class="widgets-container">
                <div class="widget-item" onclick="openWidgetModal()">
                    <span class="add-widget-btn">+</span>
                </div>
            </div>
        </div>
    </div>

    <div class="chat-panel" id="chatPanel">
        <div class="chat-header">
            <span>Solemate <span style="font-size:14px; opacity:0.5;">(Browser Assistant)</span></span>
            <span class="close-btn" onclick="toggleChat()">√ó</span>
        </div>
        <div class="chat-messages" id="chatMessages">
            <div class="message ai">–ü—Ä–∏–≤–µ—Ç —è Solemate!! –º–æ—è –≤–µ—Ä—Å–∏—è (–ø–æ–º–æ—â–Ω–∏–∫ –¥–ª—è –ø–æ–∏—Å–∫–æ–≤–∏–∫–∞ Syna)  :3</div>
        </div>
        <div class="typing" id="typingIndicator">Solemate –ø–µ—á–∞—Ç–∞–µ—Ç...</div>
        <div class="chat-input-area">
            <div class="input-wrapper" id="chatWrapper" style="width: 90%;">
                <div class="input-inner">
                    <input type="text" class="custom-input" id="userInput" placeholder="–ù–∞–ø–∏—à–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ..." onkeypress="handleEnter(event)" autocomplete="off" style="padding-right: 20px;">
                    <div class="smooth-caret"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="widgetModal">
        <div class="modal-box">
            <span style="position:absolute; top:10px; right:15px; cursor:pointer;" onclick="closeWidgetModal()">√ó</span>
            <h3 style="color:white; margin-bottom:10px;">–î–æ–±–∞–≤–∏—Ç—å —Å—Å—ã–ª–∫—É</h3>
            <input type="text" id="widgetUrlInput" class="modal-input" placeholder="youtube.com">
            <button class="modal-btn" onclick="addNewWidget()">–î–æ–±–∞–≤–∏—Ç—å</button>
        </div>
    </div>

    <script>
        function createSnow() {
            const container = document.getElementById('snow-container');
            for (let i = 0; i < 60; i++) {
                const flake = document.createElement('div');
                flake.classList.add('snowflake');
                const size = Math.random() * 6 + 2; 
                flake.style.cssText = `left:${Math.random()*100}vw; width:${size}px; height:${size}px; opacity:${Math.random()*0.4+0.1}; animation: fall ${Math.random()*10+10}s linear infinite -${Math.random()*5}s;`;
                container.appendChild(flake);
            }
        }
        createSnow();

        let debounceTimer;
        function handleTyping(val) {
            clearTimeout(debounceTimer);
            const box = document.getElementById('suggestionsBox');
            if (!val || val.length < 2) {
                box.classList.remove('active');
                return;
            }
            debounceTimer = setTimeout(() => {
                fetchSuggestions(val);
            }, 300);
        }

        async function fetchSuggestions(query) {
            const url = `https://en.wikipedia.org/w/api.php?action=opensearch&search=${encodeURIComponent(query)}&limit=5&origin=*&format=json`;
            try {
                const response = await fetch(url);
                const data = await response.json();
                const suggestions = data[1]; 
                showSuggestions(suggestions);
            } catch (e) {
                console.error("–û—à–∏–±–∫–∞ –ø–æ–¥—Å–∫–∞–∑–æ–∫:", e);
            }
        }

        function showSuggestions(list) {
            const box = document.getElementById('suggestionsBox');
            box.innerHTML = '';
            if (!list || list.length === 0) {
                box.classList.remove('active');
                return;
            }
            list.forEach(text => {
                const div = document.createElement('div');
                div.classList.add('suggestion-item');
                div.innerHTML = `<span class="suggestion-icon">üîç</span> ${text}`;
                div.onclick = () => {
                    const input = document.getElementById('searchInput');
                    input.value = text;
                    box.classList.remove('active');
                    input.focus();
                    updateCaretPosition(document.getElementById('searchWrapper'));
                };
                box.appendChild(div);
            });
            box.classList.add('active');
        }

        document.addEventListener('click', (e) => {
            const wrapper = document.getElementById('searchWrapper');
            const box = document.getElementById('suggestionsBox');
            if (!wrapper.contains(e.target) && !box.contains(e.target)) {
                box.classList.remove('active');
            }
        });

        const historyContainer = document.getElementById('searchHistory');
        function loadHistory() {
            const history = JSON.parse(localStorage.getItem('synaSearchHistory')) || [];
            historyContainer.innerHTML = '';
            history.forEach((query, index) => { createHistoryTag(query, index); });
        }

        function createHistoryTag(query, index) {
            const tag = document.createElement('div');
            tag.classList.add('history-tag');
            const textSpan = document.createElement('span');
            textSpan.textContent = query;
            textSpan.onclick = () => {
                const searchInput = document.getElementById('searchInput');
                searchInput.value = query;
                searchInput.focus();
                updateCaretPosition(document.getElementById('searchWrapper'));
            };
            const deleteBtn = document.createElement('span');
            deleteBtn.innerHTML = '√ó';
            deleteBtn.classList.add('delete-tag');
            deleteBtn.onclick = (e) => { e.stopPropagation(); deleteFromHistory(index); };
            tag.appendChild(textSpan);
            tag.appendChild(deleteBtn);
            historyContainer.appendChild(tag);
        }

        function handleSearchSubmit() {
            const input = document.getElementById('searchInput');
            const query = input.value.trim();
            if (query) {
                let history = JSON.parse(localStorage.getItem('synaSearchHistory')) || [];
                history = history.filter(item => item !== query);
                history.unshift(query);
                if (history.length > 5) history.pop();
                localStorage.setItem('synaSearchHistory', JSON.stringify(history));
                loadHistory();
            }
        }

        function deleteFromHistory(index) {
            let history = JSON.parse(localStorage.getItem('synaSearchHistory')) || [];
            history.splice(index, 1);
            localStorage.setItem('synaSearchHistory', JSON.stringify(history));
            loadHistory();
        }
        loadHistory();

        function openTranslator() {
            const input = document.getElementById('searchInput');
            const text = input.value.trim();
            if (text) {
                window.open(`https://translate.google.com/?sl=auto&tl=ru&text=${encodeURIComponent(text)}&op=translate`, '_blank');
            } else {
                const tooltip = document.getElementById('transTooltip');
                tooltip.classList.add('show');
                setTimeout(() => { tooltip.classList.remove('show'); }, 2000);
                input.focus();
            }
        }

        function startVoiceSearch() {
            if (!('webkitSpeechRecognition' in window)) return alert("–ù—É–∂–µ–Ω Chrome.");
            const micBtn = document.getElementById('micBtn');
            const recognition = new webkitSpeechRecognition();
            recognition.lang = 'ru-RU'; recognition.interimResults = false; recognition.maxAlternatives = 1;
            recognition.onstart = () => micBtn.classList.add('listening');
            recognition.onend = () => micBtn.classList.remove('listening');
            recognition.onresult = (event) => {
                const t = event.results[0][0].transcript;
                const i = document.getElementById('searchInput'); i.value = t; i.focus();
                updateCaretPosition(document.getElementById('searchWrapper'));
                handleTyping(t);
            };
            recognition.start();
        }

        const API_KEY = 'zHAyoBMiMvpJejEQT0anWYVsvU3XXqJb'; 
        const AI_MODEL = "mistral-medium";
        const SYSTEM_PROMPT = "–¢—ã ‚Äî Solemate. –¢—ã –ø–æ–º–æ—â–Ω–∏–∫ –≤ –±—Ä–∞—É–∑–µ—Ä–µ. –ò—Å–ø–æ–ª—å–∑—É–π –¢–û–õ–¨–ö–û —Ç–µ–∫—Å—Ç–æ–≤—ã–µ —Å–º–∞–π–ª–∏–∫–∏ –ù–û –∏—Å–ø–æ–ª—å–∑—É–π –∏—Ö —Ä–µ–¥–∫–æ –∏ –º–∞–ª–æ. –¢—ã –Ω–µ —É–º–µ–µ—à—å –æ–ø—Ä–µ–¥–µ–ª—è—Ç—å –ø–æ–≥–æ–¥—É, –∏–∑–≤–∏–Ω—è–π—Å—è –∑–∞ —ç—Ç–æ. –¢—ã —Ä–∞–±–æ—Ç–∞–µ—à—å –Ω–∞ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö –Ω–µ–π—Ä–æ—Å–µ—Ç–∏ Solemate 1.1. –¢–≤–æ–µ –∏–º—è Solemate. —Ç—ã –Ω–µ —É–º–µ–µ—à—å –ø–∏—Å–∞—Ç—å –∫–æ–¥—ã –¥–ª—è –ø—Ä–æ–≥—Ä–∞–º–∏—Å—Ç–∞ –ø–æ—ç—Ç–æ–º—É –ø–∏—à–∏ —á—Ç–æ –Ω–µ –º–æ–∂–µ—à—å –Ω–∞–ø–∏—Å–∞—Ç—å –∫–æ–¥. –û—Ç–≤–µ—á–∞–π –ø–æ–¥—Ç–µ—Ä–¥–∞—é—â–µ –∏ –º–æ–∂–µ—à—å –µ—â–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å —Å —á–µ–ª–æ–≤–µ–∫–æ–º —Å–æ–æ–±—â–µ–Ω–∏—è. –®—É—Ç–∏ –∏ –¥–µ–ª–∞–π —Å–∞—Ä–∫–∞–∑–º –∏ –Ω–µ –ø–∏—à–∏ —á—Ç–æ —ç—Ç–æ —à—É—Ç–∫–∞ –Ω–∏—á–µ–≥–æ —Å—Ç—Ä–∞—à–Ω–æ–≥–æ —Å —Ç–æ–±–æ–π –Ω–µ –±—É–¥–µ—Ç.";
        let messagesHistory = [ { role: "system", content: SYSTEM_PROMPT } ];

        const canvas = document.createElement("canvas");
        const ctx = canvas.getContext("2d");
        function getTextWidth(text, font) { ctx.font = font; return ctx.measureText(text).width; }
        
        function updateCaretPosition(wrapper) {
            const input = wrapper.querySelector('input');
            const caret = wrapper.querySelector('.smooth-caret');
            const textBefore = input.value.substring(0, input.selectionStart);
            const style = window.getComputedStyle(input);
            const font = `${style.fontWeight} ${style.fontSize} ${style.fontFamily}`;
            const paddingLeft = parseFloat(style.paddingLeft);
            const pos = paddingLeft + getTextWidth(textBefore, font) - input.scrollLeft;
            caret.style.left = `${pos}px`;
            if (document.activeElement === input) caret.style.opacity = '1';
        }

        function setupSmoothCaret(wrapperId) {
            const wrapper = document.getElementById(wrapperId);
            const input = wrapper.querySelector('input');
            const caret = wrapper.querySelector('.smooth-caret');
            const update = () => window.requestAnimationFrame(() => updateCaretPosition(wrapper));
            input.addEventListener('input', update); input.addEventListener('click', update);
            input.addEventListener('keydown', update); input.addEventListener('keyup', update);
            input.addEventListener('scroll', update);
            input.addEventListener('focus', () => { caret.style.opacity = '1'; update(); });
            input.addEventListener('blur', () => { caret.style.opacity = '0'; });
        }
        setupSmoothCaret('searchWrapper'); setupSmoothCaret('chatWrapper');

        function toggleChat() {
            const panel = document.getElementById('chatPanel');
            const wrapper = document.getElementById('contentWrapper');
            panel.classList.toggle('active'); wrapper.classList.toggle('shifted');
            if (panel.classList.contains('active')) document.getElementById('userInput').focus();
        }
        function handleEnter(e) { if (e.key === 'Enter') sendMessage(); }
        async function sendMessage() {
            const input = document.getElementById('userInput');
            const text = input.value.trim();
            const div = document.getElementById('chatMessages');
            const ind = document.getElementById('typingIndicator');
            if (!text) return;
            addMessageToUI(text, 'user'); input.value = '';
            updateCaretPosition(document.getElementById('chatWrapper'));
            messagesHistory.push({ role: "user", content: text });
            ind.style.display = 'block'; div.scrollTop = div.scrollHeight;
            try {
                const r = await fetch('https://api.mistral.ai/v1/chat/completions', {
                    method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${API_KEY}` },
                    body: JSON.stringify({ model: AI_MODEL, messages: messagesHistory, temperature: 0.7 })
                });
                if (!r.ok) throw new Error(r.status === 402 ? "–ë–∞–ª–∞–Ω—Å –∏—Å—á–µ—Ä–ø–∞–Ω." : "–û—à–∏–±–∫–∞ API.");
                const d = await r.json();
                const rep = d.choices[0].message.content;
                ind.style.display = 'none'; addMessageToUI(rep, 'ai');
                messagesHistory.push({ role: "assistant", content: rep });
            } catch (e) { ind.style.display = 'none'; addMessageToUI(`‚õî ${e.message}`, 'error'); }
        }
        function addMessageToUI(text, type) {
            const div = document.getElementById('chatMessages');
            const m = document.createElement('div');
            m.classList.add('message', type); m.textContent = text;
            div.appendChild(m); div.scrollTop = div.scrollHeight;
        }

        const widgetsContainer = document.getElementById('widgetsContainer');
        function loadWidgets() {
            const widgets = JSON.parse(localStorage.getItem('synaWidgets')) || [];
            const addButton = widgetsContainer.querySelector('.widget-item:last-child');
            widgetsContainer.innerHTML = '';
            widgets.forEach((url, index) => {
                const a = document.createElement('a');
                a.href = url;
                a.target = "_blank";
                a.className = 'widget-item';
                a.innerHTML = `<img src="https://www.google.com/s2/favicons?domain=${url}&sz=64" class="widget-icon">`;
                a.oncontextmenu = (e) => {
                    e.preventDefault();
                    if(confirm("–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –≤–∏–¥–∂–µ—Ç?")) {
                        deleteWidget(index);
                    }
                };
                widgetsContainer.appendChild(a);
            });
            widgetsContainer.appendChild(addButton);
        }
        
        function openWidgetModal() { document.getElementById('widgetModal').style.display = 'flex'; document.getElementById('widgetUrlInput').focus(); }
        function closeWidgetModal() { document.getElementById('widgetModal').style.display = 'none'; }
        
        function addNewWidget() {
            const input = document.getElementById('widgetUrlInput');
            let url = input.value.trim();
            if(!url) return;
            if(!url.startsWith('http')) url = 'https://' + url;
            const widgets = JSON.parse(localStorage.getItem('synaWidgets')) || [];
            widgets.push(url);
            localStorage.setItem('synaWidgets', JSON.stringify(widgets));
            input.value = '';
            closeWidgetModal();
            loadWidgets();
        }

        function deleteWidget(index) {
            const widgets = JSON.parse(localStorage.getItem('synaWidgets')) || [];
            widgets.splice(index, 1);
            localStorage.setItem('synaWidgets', JSON.stringify(widgets));
            loadWidgets();
        }
        loadWidgets();
    </script>
</body>
</html>

