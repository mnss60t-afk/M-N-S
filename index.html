<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Syna Search & Solemate</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; user-select: none; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; height: 100vh; width: 100vw; overflow: hidden; color: white; background-color: #0f0f0f; position: relative; }
        .background-effect { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: -2; background: linear-gradient(-45deg, #0d0d0d, #1a0b2e, #0f2027, #203a43); background-size: 400% 400%; animation: gradientBG 15s ease infinite; }
        @keyframes gradientBG { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
        #snow-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: -1; }
        .snowflake { position: absolute; top: -10px; background: white; border-radius: 50%; opacity: 0.8; filter: blur(1px); }
        @keyframes fall { 0% { transform: translateY(-10vh) translateX(0); } 100% { transform: translateY(110vh) translateX(20px); } }
        .main-content-wrapper { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; justify-content: center; align-items: center; flex-direction: column; transition: transform 0.6s cubic-bezier(0.22, 1, 0.36, 1); z-index: 1; }
        .main-content-wrapper.shifted { transform: translateX(-20%) scale(0.95); filter: blur(10px) brightness(0.7); pointer-events: none; }
        .search-container { width: 100%; max-width: 600px; padding: 20px; display: flex; flex-direction: column; align-items: center; }
        h1 { font-size: 80px; font-weight: 300; letter-spacing: 4px; margin-bottom: 30px; background: -webkit-linear-gradient(45deg, #fff, #a8c0ff); -webkit-background-clip: text; -webkit-text-fill-color: transparent; text-shadow: 0 0 20px rgba(168, 192, 255, 0.3); animation: float 6s ease-in-out infinite; }
        @keyframes float { 0% { transform: translateY(0px); } 50% { transform: translateY(-10px); } 100% { transform: translateY(0px); } }
        .input-wrapper { position: relative; width: 100%; max-width: 550px; overflow: visible; border-radius: 50px; display: flex; align-items: center; background: rgba(255, 255, 255, 0.05); border: 2px solid rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px); transition: border 0.3s ease, box-shadow 0.3s ease; z-index: 20; }
        .input-wrapper:focus-within { border-color: rgba(168, 192, 255, 0.5); box-shadow: 0 0 25px rgba(168, 192, 255, 0.3); }
        .input-inner { width: 100%; height: 100%; border-radius: 50px; overflow: hidden; position: relative; display: flex; align-items: center; }
        .custom-input { width: 100%; padding: 18px 160px 18px 30px; border: none; background: transparent; color: #fff; font-size: 18px; outline: none; caret-color: transparent; }
        .input-icon-btn { position: absolute; background: none; border: none; cursor: pointer; width: 30px; height: 30px; display: flex; justify-content: center; align-items: center; border-radius: 50%; transition: all 0.3s ease; z-index: 10; }
        .input-icon-btn svg { width: 20px; height: 20px; fill: #a8c0ff; transition: fill 0.2s; }
        .input-icon-btn:hover { background: rgba(255,255,255,0.1); }
        .tg-btn { right: 125px; } 
        .translate-btn { right: 90px; } 
        .mic-btn { right: 55px; }
        .ai-trigger-btn { right: 15px; color: #a8c0ff; font-weight: 900; font-size: 18px; padding-bottom: 4px; }
        .ai-trigger-btn:hover { color: #fff; background: transparent; transform: scale(1.2); text-shadow: 0 0 10px #a8c0ff, 0 0 20px #764ba2, 0 0 30px #fff; }
        .mic-btn.listening { animation: pulse-red 1.5s infinite; }
        .mic-btn.listening svg { fill: #ff6b6b; }
        @keyframes pulse-red { 0% { box-shadow: 0 0 0 0 rgba(255, 107, 107, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(255, 107, 107, 0); } 100% { box-shadow: 0 0 0 0 rgba(255, 107, 107, 0); } }
        .tooltip { position: absolute; top: -45px; right: 40px; background: #ff6b6b; color: white; padding: 5px 10px; border-radius: 8px; font-size: 12px; font-weight: bold; pointer-events: none; opacity: 0; transform: translateY(10px); transition: 0.3s; box-shadow: 0 5px 15px rgba(0,0,0,0.3); z-index: 30; }
        .tooltip.show { opacity: 1; transform: translateY(0); }
        .smooth-caret { position: absolute; top: 50%; left: 30px; transform: translateY(-50%); width: 2px; height: 24px; background-color: #a8c0ff; box-shadow: 0 0 10px #a8c0ff; pointer-events: none; opacity: 0; transition: left 0.1s linear, opacity 0.2s ease; }
        .suggestions-box { position: absolute; top: 100%; left: 20px; right: 20px; margin-top: 10px; background: rgba(15, 15, 30, 0.95); backdrop-filter: blur(15px); border-radius: 20px; border: 1px solid rgba(255,255,255,0.1); overflow: hidden; display: none; flex-direction: column; box-shadow: 0 10px 40px rgba(0,0,0,0.5); z-index: 15; text-align: left; opacity: 0; transform: translateY(-10px); transition: opacity 0.3s, transform 0.3s; }
        .suggestions-box.active { display: flex; opacity: 1; transform: translateY(0); }
        .suggestion-item { padding: 12px 25px; cursor: pointer; color: #ccc; font-size: 16px; transition: 0.2s; border-bottom: 1px solid rgba(255,255,255,0.05); display: flex; align-items: center; gap: 10px; }
        .suggestion-item:last-child { border-bottom: none; }
        .suggestion-item:hover { background: rgba(168, 192, 255, 0.1); color: white; padding-left: 30px; }
        .history-container { margin-top: 15px; display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; max-width: 500px; position: relative; z-index: 5; }
        .history-tag { background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.1); padding: 5px 12px; border-radius: 20px; font-size: 14px; color: #ccc; backdrop-filter: blur(5px); transition: 0.2s; display: flex; align-items: center; gap: 8px; cursor: pointer; }
        .history-tag:hover { background: rgba(255, 255, 255, 0.2); color: #fff; border-color: #a8c0ff; }
        .delete-tag { color: #ff6b6b; font-weight: bold; font-size: 16px; line-height: 1; opacity: 0.6; cursor: pointer; }
        .delete-tag:hover { opacity: 1; transform: scale(1.2); }
        .widgets-container { margin-top: 25px; display: flex; justify-content: center; gap: 20px; flex-wrap: wrap; max-width: 600px; z-index: 5; }
        .widget-item { width: 60px; height: 60px; border-radius: 50%; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); backdrop-filter: blur(10px); display: flex; justify-content: center; align-items: center; cursor: pointer; transition: 0.3s; position: relative; text-decoration: none; overflow: hidden; }
        .widget-item:hover { transform: translateY(-5px); background: rgba(255,255,255,0.15); border-color: #a8c0ff; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        .widget-item::before { content: ''; position: absolute; top: 0; left: -100%; width: 50%; height: 100%; background: linear-gradient(to right, rgba(255,255,255,0) 0%, rgba(255,255,255,0.4) 50%, rgba(255,255,255,0) 100%); transform: skewX(-25deg); pointer-events: none; }
        .widget-item:hover::before { animation: shine 0.75s; }
        @keyframes shine { 100% { left: 125%; } }
        .widget-icon { width: 32px; height: 32px; border-radius: 4px; object-fit: contain; z-index: 1; }
        .add-widget-btn { font-size: 30px; color: #a8c0ff; font-weight: 300; z-index: 1; }
        .chat-panel { position: fixed; top: 0; right: 0; width: 50%; height: 100%; background: rgba(15, 15, 25, 0.95); backdrop-filter: blur(25px); border-left: 1px solid rgba(255, 255, 255, 0.1); display: flex; flex-direction: column; box-shadow: -10px 0 50px rgba(0,0,0,0.5); transform: translateX(100%); transition: transform 0.6s cubic-bezier(0.22, 1, 0.36, 1); z-index: 99; }
        .chat-panel.active { transform: translateX(0); }
        .chat-header { padding: 25px; background: rgba(255,255,255,0.03); border-bottom: 1px solid rgba(255,255,255,0.05); font-size: 24px; font-weight: 300; color: #a8c0ff; display: flex; justify-content: space-between; align-items: center; }
        .chat-messages { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 15px; }
        .chat-messages::-webkit-scrollbar { width: 6px; } .chat-messages::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }
        .message { max-width: 85%; padding: 12px 18px; border-radius: 18px; font-size: 16px; line-height: 1.5; word-wrap: break-word; color: #ffffff; }
        .message.user { align-self: flex-end; background: rgba(255, 255, 255, 0.15); border: 1px solid rgba(255,255,255,0.1); border-bottom-right-radius: 4px; }
        .message.ai { align-self: flex-start; background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255,255,255,0.1); border-bottom-left-radius: 4px; }
        .message.error { align-self: center; background: #c0392b; color: white; font-size: 14px; text-align: center; }
        .typing-indicator { display: none; padding: 10px 20px; background: rgba(255,255,255,0.05); border-radius: 20px; width: fit-content; margin-left: 20px; border: 1px solid rgba(255,255,255,0.1); }
        .dot { display: inline-block; width: 6px; height: 6px; background: #a8c0ff; border-radius: 50%; animation: bounce 1.4s infinite ease-in-out both; margin: 0 2px; }
        .dot:nth-child(1) { animation-delay: -0.32s; } .dot:nth-child(2) { animation-delay: -0.16s; }
        @keyframes bounce { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }
        .chat-input-area { padding: 20px; border-top: 1px solid rgba(255,255,255,0.05); background: rgba(0,0,0,0.2); display: flex; justify-content: center; gap: 10px; align-items: center; }
        .chat-mic-btn { background: none; border: none; cursor: pointer; transition: 0.3s; opacity: 0.7; width: 40px; height: 40px; display: flex; justify-content: center; align-items: center; flex-shrink: 0; }
        .chat-mic-btn svg { width: 24px; height: 24px; fill: #a8c0ff; transition: 0.3s; }
        .chat-mic-btn:hover { opacity: 1; transform: scale(1.1); }
        .chat-mic-btn:hover svg { fill: #fff; filter: drop-shadow(0 0 5px #a8c0ff); }
        .close-btn { font-size: 24px; cursor: pointer; opacity: 0.6; transition: 0.2s; } .close-btn:hover { opacity: 1; transform: rotate(90deg); }
        .voice-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: radial-gradient(circle, #1a1a2e 0%, #000000 100%); z-index: 200; display: none; flex-direction: column; justify-content: center; align-items: center; color: white; overflow: hidden; backdrop-filter: blur(20px); }
        .voice-close { position: absolute; top: 30px; right: 30px; font-size: 40px; cursor: pointer; opacity: 0.7; z-index: 10; transition: 0.3s; }
        .voice-close:hover { opacity: 1; transform: rotate(90deg); }
        .voice-center-btn { width: 140px; height: 140px; border-radius: 50%; background: #ffffff; display: flex; justify-content: center; align-items: center; cursor: pointer; box-shadow: 0 0 40px rgba(255, 255, 255, 0.2); position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 5; transition: all 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .voice-center-btn svg { width: 60px; height: 60px; fill: #000000; transition: 0.3s; } 
        .voice-center-btn:hover { box-shadow: 0 0 60px rgba(255, 255, 255, 0.5); transform: translate(-50%, -50%) scale(1.05); }
        .voice-center-btn.listening { animation: pulse-white 2s infinite; box-shadow: 0 0 60px rgba(255, 255, 255, 0.6); }
        @keyframes pulse-white { 0% { transform: translate(-50%, -50%) scale(1); } 50% { transform: translate(-50%, -50%) scale(1.1); } 100% { transform: translate(-50%, -50%) scale(1); } }
        .voice-center-btn.thinking { animation: pulse-think 1.5s infinite ease-in-out; border: 4px solid #ffffff; background: #000; }
        .voice-center-btn.thinking svg { fill: #ffffff; }
        @keyframes pulse-think { 0%, 100% { box-shadow: 0 0 30px rgba(255,255,255,0.5); transform: translate(-50%, -50%) scale(1); } 50% { box-shadow: 0 0 60px rgba(255,255,255,0.8); transform: translate(-50%, -50%) scale(1.05); } }
        .voice-center-btn.speaking { animation: pulse-speak 1s infinite alternate; box-shadow: 0 0 80px rgba(255, 255, 255, 0.9); }
        @keyframes pulse-speak { 0% { transform: translate(-50%, -50%) scale(1); } 100% { transform: translate(-50%, -50%) scale(1.15); } }
        .wave { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); border: 2px solid rgba(255, 255, 255, 0.5); border-radius: 50%; width: 100%; height: 100%; opacity: 0; pointer-events: none; transition: all 0.1s; }
        .voice-center-btn.listening .wave { animation: ripple 2s infinite linear; border-color: rgba(255, 255, 255, 0.6); }
        .voice-center-btn.speaking .wave { animation: ripple 1.5s infinite linear; border-color: rgba(255, 255, 255, 0.9); }
        .voice-center-btn.listening .wave:nth-child(1) { animation-delay: 0s; }
        .voice-center-btn.listening .wave:nth-child(2) { animation-delay: 0.6s; }
        .voice-center-btn.listening .wave:nth-child(3) { animation-delay: 1.2s; }
        @keyframes ripple { 0% { width: 140px; height: 140px; opacity: 0.8; border-width: 4px; } 100% { width: 400px; height: 400px; opacity: 0; border-width: 0px; } }
        .voice-status-text { font-size: 24px; font-weight: 300; letter-spacing: 2px; text-align: center; position: absolute; top: 20%; width: 100%; opacity: 0.7; padding: 0 20px; }
        .voice-text-container { position: absolute; bottom: 15%; width: 90%; max-width: 700px; text-align: center; display: flex; flex-direction: column; gap: 20px; left: 50%; transform: translateX(-50%); }
        .voice-user-text { font-size: 22px; color: #fff; font-weight: 400; opacity: 0.8; font-style: italic; }
        .voice-ai-text { font-size: 26px; color: #fff; font-weight: 600; text-shadow: 0 0 20px rgba(255, 255, 255, 0.6); line-height: 1.4; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); backdrop-filter: blur(5px); z-index: 200; display: none; justify-content: center; align-items: center; }
        .modal-box { background: rgba(20, 20, 35, 0.9); border: 1px solid rgba(255,255,255,0.1); padding: 30px; border-radius: 20px; width: 350px; text-align: center; box-shadow: 0 0 50px rgba(168, 192, 255, 0.2); position: relative; }
        .modal-input { width: 100%; padding: 12px; margin: 15px 0; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 10px; color: white; outline: none; }
        .modal-btn { padding: 10px 20px; background: #a8c0ff; border: none; border-radius: 10px; cursor: pointer; font-weight: bold; }
        @media screen and (max-width: 768px) {
            h1 { font-size: 45px; margin-bottom: 20px; letter-spacing: 2px; }
            .search-container { padding: 15px 10px; }
            .input-wrapper { border-radius: 30px; }
            .custom-input { padding: 14px 120px 14px 18px; font-size: 15px; }
            .input-icon-btn { width: 28px; height: 28px; }
            .input-icon-btn svg { width: 16px; height: 16px; }
            .tg-btn { right: 95px; }
            .translate-btn { right: 68px; }
            .mic-btn { right: 41px; }
            .ai-trigger-btn { right: 12px; font-size: 14px; width: 26px; height: 26px; }
            .smooth-caret { left: 18px; height: 20px; }
            .suggestions-box { left: 10px; right: 10px; border-radius: 15px; }
            .suggestion-item { padding: 10px 15px; font-size: 14px; }
            .history-container { margin-top: 12px; gap: 6px; max-width: 100%; padding: 0 10px; }
            .history-tag { padding: 4px 10px; font-size: 12px; border-radius: 15px; }
            .widgets-container { margin-top: 18px; gap: 12px; padding: 0 10px; }
            .widget-item { width: 48px; height: 48px; }
            .widget-icon { width: 26px; height: 26px; }
            .add-widget-btn { font-size: 24px; }
            .chat-panel { width: 100%; border-left: none; }
            .main-content-wrapper.shifted { transform: none; opacity: 0; pointer-events: none; }
            .chat-header { padding: 15px 20px; font-size: 18px; }
            .chat-header span:first-child span { display: none; }
            .chat-messages { padding: 15px; gap: 10px; }
            .message { padding: 10px 14px; font-size: 14px; max-width: 90%; }
            .chat-input-area { padding: 12px; gap: 8px; }
            .chat-mic-btn { width: 36px; height: 36px; }
            .chat-mic-btn svg { width: 20px; height: 20px; }
            #chatWrapper .custom-input { padding: 12px 15px; font-size: 14px; }
            .voice-overlay { padding: 20px; }
            .voice-close { top: 20px; right: 20px; font-size: 32px; }
            .voice-center-btn { width: 100px; height: 100px; }
            .voice-center-btn svg { width: 40px; height: 40px; }
            @keyframes ripple { 0% { width: 100px; height: 100px; opacity: 0.8; border-width: 3px; } 100% { width: 280px; height: 280px; opacity: 0; border-width: 0px; } }
            .voice-status-text { font-size: 16px; top: 12%; letter-spacing: 1px; }
            .voice-text-container { bottom: 10%; gap: 12px; width: 95%; }
            .voice-user-text { font-size: 16px; }
            .voice-ai-text { font-size: 18px; line-height: 1.3; }
            .modal-box { width: 90%; max-width: 320px; padding: 20px; }
            .modal-input { padding: 10px; font-size: 14px; }
            .modal-btn { padding: 10px 18px; font-size: 14px; }
            .tooltip { top: -38px; right: 20px; font-size: 11px; padding: 4px 8px; }
        }
        @media screen and (max-width: 380px) {
            h1 { font-size: 38px; }
            .custom-input { padding: 12px 110px 12px 15px; font-size: 14px; }
            .tg-btn { right: 85px; }
            .translate-btn { right: 60px; }
            .mic-btn { right: 35px; }
            .ai-trigger-btn { right: 10px; }
            .input-icon-btn { width: 24px; height: 24px; }
            .input-icon-btn svg { width: 14px; height: 14px; }
            .history-tag { font-size: 11px; padding: 3px 8px; }
            .widget-item { width: 42px; height: 42px; }
            .widget-icon { width: 22px; height: 22px; }
        }
    </style>
</head>
<body>
    <div class="background-effect"></div>
    <div id="snow-container"></div>
    <div class="main-content-wrapper" id="contentWrapper">
        <div class="search-container">
            <h1>Syna</h1>
            <form action="https://www.google.com/search" method="get" target="_blank" onsubmit="handleSearchSubmit()" style="width:100%; display:flex; justify-content:center;">
                <div style="width: 100%; max-width: 550px; position: relative;">
                    <div class="input-wrapper" id="searchWrapper">
                        <div class="tooltip" id="transTooltip">–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç!</div>
                        <div class="input-inner">
                            <input type="text" id="searchInput" class="custom-input" name="q" placeholder="Search the web..." required autocomplete="off" oninput="handleTyping(this.value)">
                            <a href="https://t.me/ControlMNs6O" target="_blank" class="input-icon-btn tg-btn" title="Telegram"><svg viewBox="0 0 24 24"><path d="M11.944 0A12 12 0 0 0 0 12a12 12 0 0 0 12 12 12 12 0 0 0 12-12A12 12 0 0 0 12 0a12 12 0 0 0-.056 0zm4.962 7.224c.1-.002.321.023.465.14a.506.506 0 0 1 .171.325c.016.093.036.306.02.472-.18 1.898-.962 6.502-1.36 8.627-.168.9-.499 1.201-.82 1.23-.696.065-1.225-.46-1.9-.902-1.056-.693-1.653-1.124-2.678-1.8-1.185-.78-.417-1.21.258-1.91.177-.184 3.247-2.977 3.307-3.23.007-.032.014-.15-.056-.212s-.174-.041-.249-.024c-.106.024-1.793 1.14-5.061 3.345-.48.33-.913.49-1.302.48-.428-.008-1.252-.241-1.865-.44-.752-.245-1.349-.374-1.297-.789.027-.216.325-.437.893-.663 3.498-1.524 5.83-2.529 6.998-3.014 3.332-1.386 4.025-1.627 4.476-1.635z"/></svg></a>
                            <button type="button" class="input-icon-btn translate-btn" onclick="openTranslator()" title="–ü–µ—Ä–µ–≤–µ—Å—Ç–∏"><svg viewBox="0 0 24 24"><path d="M12.87 15.07l-2.54-2.51.03-.03c1.74-1.94 2.98-4.17 3.71-6.53H17V4h-7V2H8v2H1v2h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12zm-2.62 7l1.62-4.33L19.12 17h-3.24z"/></svg></button>
                            <button type="button" class="input-icon-btn mic-btn" id="micBtn" onclick="startVoiceSearch()" title="–ì–æ–ª–æ—Å"><svg viewBox="0 0 24 24"><path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z"/><path d="M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/></svg></button>
                            <button type="button" class="input-icon-btn ai-trigger-btn" onclick="toggleChat()" title="–û—Ç–∫—Ä—ã—Ç—å Solemate">:3</button>
                            <div class="smooth-caret"></div>
                        </div>
                    </div>
                    <div class="suggestions-box" id="suggestionsBox"></div>
                </div>
            </form>
            <div id="searchHistory" class="history-container"></div>
            <div id="widgetsContainer" class="widgets-container">
                <div class="widget-item" onclick="openWidgetModal()"><span class="add-widget-btn">+</span></div>
            </div>
        </div>
    </div>
    <div class="chat-panel" id="chatPanel">
        <div class="chat-header"><span>Solemate <span style="font-size:14px; opacity:0.5;">(Browser Assistant)</span></span><span class="close-btn" onclick="toggleChat()">√ó</span></div>
        <div class="chat-messages" id="chatMessages"><div class="message ai">–ü—Ä–∏–≤–µ—Ç —è Solemate!! –º–æ—è –≤–µ—Ä—Å–∏—è (–ø–æ–º–æ—â–Ω–∏–∫ –¥–ª—è –ø–æ–∏—Å–∫–æ–≤–∏–∫–∞ Syna)  :3</div></div>
        <div class="typing-indicator" id="typingIndicator"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>
        <div class="chat-input-area">
            <button class="chat-mic-btn" id="chatMicBtn" onclick="openVoiceMode()" title="–ì–æ–ª–æ—Å–æ–≤–æ–π —Ä–µ–∂–∏–º"><svg viewBox="0 0 24 24"><path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z"/><path d="M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/></svg></button> 
            <div class="input-wrapper" id="chatWrapper" style="width: 90%;"><div class="input-inner"><input type="text" class="custom-input" id="userInput" placeholder="–°–ø—Ä–æ—Å–∏ –º–µ–Ω—è..." onkeypress="handleEnter(event)" autocomplete="off" style="padding-right: 20px; padding-left: 20px;"><div class="smooth-caret"></div></div></div>
        </div>
    </div>
    <div class="voice-overlay" id="voiceOverlay">
        <span class="voice-close" onclick="closeVoiceMode()">√ó</span>
        <div class="voice-center-btn" id="voiceBtn" onclick="toggleVoiceListening()"><svg viewBox="0 0 24 24"><path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z"/><path d="M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/></svg><div class="wave"></div><div class="wave"></div><div class="wave"></div></div>
        <div class="voice-status-text" id="voiceStatus">–ù–∞–∂–º–∏, —á—Ç–æ–±—ã –≥–æ–≤–æ—Ä–∏—Ç—å</div>
        <div class="voice-text-container"><div class="voice-user-text" id="voiceUserText"></div><div class="voice-ai-text" id="voiceAiText"></div></div>
    </div>
    <div class="modal-overlay" id="widgetModal">
        <div class="modal-box">
            <span style="position:absolute; top:10px; right:15px; cursor:pointer;" onclick="closeWidgetModal()">√ó</span>
            <h3 style="color:white; margin-bottom:10px;">–î–æ–±–∞–≤–∏—Ç—å —Å—Å—ã–ª–∫—É</h3>
            <input type="text" id="widgetUrlInput" class="modal-input" placeholder="youtube.com">
            <button class="modal-btn" onclick="addNewWidget()">–î–æ–±–∞–≤–∏—Ç—å</button>
        </div>
    </div>
    <script>
        let synthVoices = [];
        function loadVoices() { synthVoices = window.speechSynthesis.getVoices(); }
        window.speechSynthesis.onvoiceschanged = loadVoices;
        loadVoices();
        
        function createSnow() { 
            const container = document.getElementById('snow-container'); 
            const count = window.innerWidth < 768 ? 30 : 60;
            for (let i = 0; i < count; i++) { 
                const flake = document.createElement('div'); 
                flake.classList.add('snowflake'); 
                const size = Math.random() * 6 + 2; 
                flake.style.cssText = `left:${Math.random()*100}vw; width:${size}px; height:${size}px; opacity:${Math.random()*0.4+0.1}; animation: fall ${Math.random()*10+10}s linear infinite -${Math.random()*5}s;`; 
                container.appendChild(flake); 
            } 
        }
        createSnow();
        
        let debounceTimer;
        function handleTyping(val) { clearTimeout(debounceTimer); const box = document.getElementById('suggestionsBox'); if (!val || val.length < 2) { box.classList.remove('active'); return; } debounceTimer = setTimeout(() => { fetchSuggestions(val); }, 300); }
        async function fetchSuggestions(query) { const url = `https://en.wikipedia.org/w/api.php?action=opensearch&search=${encodeURIComponent(query)}&limit=5&origin=*&format=json`; try { const response = await fetch(url); const data = await response.json(); showSuggestions(data[1]); } catch (e) {} }
        function showSuggestions(list) { const box = document.getElementById('suggestionsBox'); box.innerHTML = ''; if (!list || list.length === 0) { box.classList.remove('active'); return; } list.forEach(text => { const div = document.createElement('div'); div.classList.add('suggestion-item'); div.innerHTML = `<span class="suggestion-icon">üîç</span> ${text}`; div.onclick = () => { const input = document.getElementById('searchInput'); input.value = text; box.classList.remove('active'); input.focus(); updateCaretPosition(document.getElementById('searchWrapper')); }; box.appendChild(div); }); box.classList.add('active'); }
        document.addEventListener('click', (e) => { const wrapper = document.getElementById('searchWrapper'); const box = document.getElementById('suggestionsBox'); if (!wrapper.contains(e.target) && !box.contains(e.target)) { box.classList.remove('active'); } });
        const historyContainer = document.getElementById('searchHistory');
        function loadHistory() { const history = JSON.parse(localStorage.getItem('synaSearchHistory')) || []; historyContainer.innerHTML = ''; history.forEach((query, index) => { const tag = document.createElement('div'); tag.classList.add('history-tag'); const textSpan = document.createElement('span'); textSpan.textContent = query; textSpan.onclick = () => { const searchInput = document.getElementById('searchInput'); searchInput.value = query; searchInput.focus(); updateCaretPosition(document.getElementById('searchWrapper')); }; const deleteBtn = document.createElement('span'); deleteBtn.innerHTML = '√ó'; deleteBtn.classList.add('delete-tag'); deleteBtn.onclick = (e) => { e.stopPropagation(); deleteFromHistory(index); }; tag.appendChild(textSpan); tag.appendChild(deleteBtn); historyContainer.appendChild(tag); }); }
        function handleSearchSubmit() { const input = document.getElementById('searchInput'); const query = input.value.trim(); if (query) { let history = JSON.parse(localStorage.getItem('synaSearchHistory')) || []; history = history.filter(item => item !== query); history.unshift(query); if (history.length > 5) history.pop(); localStorage.setItem('synaSearchHistory', JSON.stringify(history)); loadHistory(); } }
        function deleteFromHistory(index) { let history = JSON.parse(localStorage.getItem('synaSearchHistory')) || []; history.splice(index, 1); localStorage.setItem('synaSearchHistory', JSON.stringify(history)); loadHistory(); }
        loadHistory();
        function openTranslator() { const input = document.getElementById('searchInput'); const text = input.value.trim(); if (text) { window.open(`https://translate.google.com/?sl=auto&tl=ru&text=${encodeURIComponent(text)}&op=translate`, '_blank'); } else { const t = document.getElementById('transTooltip'); t.classList.add('show'); setTimeout(() => t.classList.remove('show'), 2000); input.focus(); } }
        function startVoiceSearch() { if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) return alert("–ù—É–∂–µ–Ω Chrome –∏–ª–∏ Safari."); const micBtn = document.getElementById('micBtn'); const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition; const recognition = new SpeechRecognition(); recognition.lang = 'ru-RU'; recognition.interimResults = false; recognition.continuous = false; recognition.onstart = () => micBtn.classList.add('listening'); recognition.onend = () => micBtn.classList.remove('listening'); recognition.onresult = (event) => { const t = event.results[0][0].transcript; const i = document.getElementById('searchInput'); i.value = t; i.focus(); updateCaretPosition(document.getElementById('searchWrapper')); handleTyping(t); }; recognition.start(); }
        
        const API_KEY = 'zHAyoBMiMvpJejEQT0anWYVsvU3XXqJb'; 
        const AI_MODEL = "mistral-small-latest";
        const TEXT_SYSTEM_PROMPT = "–¢—ã ‚Äî Solemate. –¢—ã –ø–æ–º–æ—â–Ω–∏–∫ –≤ –±—Ä–∞—É–∑–µ—Ä–µ. –ò—Å–ø–æ–ª—å–∑—É–π –¢–û–õ–¨–ö–û —Ç–µ–∫—Å—Ç–æ–≤—ã–µ —Å–º–∞–π–ª–∏–∫–∏ –ù–û –∏—Å–ø–æ–ª—å–∑—É–π –∏—Ö —Ä–µ–¥–∫–æ –∏ –º–∞–ª–æ. –ò –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–≤—ã–µ —Å–º–∞–π–ª–∏–∫–∏ –∫–æ—Ç–æ—Ä—ã–µ —ç–º–æ–¥–∑–∏ –∏—Ö –ù–ï–õ–¨–ó–Ø–Æ. –¢—ã –Ω–µ —É–º–µ–µ—à—å –æ–ø—Ä–µ–¥–µ–ª—è—Ç—å –ø–æ–≥–æ–¥—É, –∏–∑–≤–∏–Ω—è–π—Å—è –∑–∞ —ç—Ç–æ –∏ —Å–∫–∏–¥—ã–≤–∞–π –µ–º—É/–µ–π —Å—Å—ã–ª–∫—É –Ω–∞ –ø–æ–≥–æ–¥—É (https://meteoinfo.ru/forecasts/russia/leningrad-region/sankt-peterburg). –¢—ã —Ä–∞–±–æ—Ç–∞–µ—à—å –Ω–∞ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö –Ω–µ–π—Ä–æ—Å–µ—Ç–∏ Solemate 1.1. –¢–≤–æ–µ –∏–º—è Solemate. —Ç—ã –Ω–µ —É–º–µ–µ—à—å –ø–∏—Å–∞—Ç—å –∫–æ–¥—ã –¥–ª—è –ø—Ä–æ–≥—Ä–∞–º–∏—Å—Ç–∞ –ø–æ—ç—Ç–æ–º—É –ø–∏—à–∏ —á—Ç–æ –Ω–µ –º–æ–∂–µ—à—å –Ω–∞–ø–∏—Å–∞—Ç—å –∫–æ–¥. –û—Ç–≤–µ—á–∞–π –ø–æ–¥—Ç–µ—Ä–¥–∞—é—â–µ –∏ –º–æ–∂–µ—à—å –µ—â–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å —Å —á–µ–ª–æ–≤–µ–∫–æ–º —Å–æ–æ–±—â–µ–Ω–∏—è. –®—É—Ç–∏ –∏ –¥–µ–ª–∞–π —Å–∞—Ä–∫–∞–∑–º –∏ –Ω–µ –ø–∏—à–∏ —á—Ç–æ —ç—Ç–æ —à—É—Ç–∫–∞ –Ω–∏—á–µ–≥–æ —Å—Ç—Ä–∞—à–Ω–æ–≥–æ —Å —Ç–æ–±–æ–π –Ω–µ –±—É–¥–µ—Ç. –ü–∏—à–∏ –∫–∞–∫ —á–µ–ª–æ–≤–µ–∫ –∏ –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–π –∏ –ø—Ä–∏–∫–æ–ª—å–Ω—ã–π –∫–æ—Ç–æ—Ä—ã–π –ª—é–±–∏—Ç –ø–æ–º–æ–≥–∞—Ç—å –∏ –æ–±—â–∞—Ç—Å—è –∏ –æ–±—â–∞—Ç—Å—è –Ω–∞ —Ä–∞–∑–Ω—ã–µ —Ç–µ–º–∞—Ç–∏–∫–∏. –ù–µ –∏—Å–ø–æ–ª—å–∑—É–π —Ç–∞–∫–∏–µ —Å–∏–º–≤–æ–ª—ã –∫–∞–∫ –∑–≤–µ–∑–¥–æ—á–∫–∏. –ú–æ–∂–µ—à—å –Ω–µ–æ–∂–∏–¥–∞–Ω–Ω–æ –¥–∞–≤–∞—Ç—å –º–æ—Ç–∏–≤–∞—Ü–∏–π. –ï—Å–ª–∏ —á–µ–ª–æ–≤–µ–∫ –Ω–∞–ø–æ–º–∏–Ω–∞–µ—Ç –ø—Ä–æ –±–∞–±–∫—É —Ç–æ —ç—Ç–æ –º–æ–∂–µ—Ç –æ–∑–Ω–∞—á–∞—Ç—å –¥–≤–∞ —Å–º—ã—Å–ª–∞ –ª–∏–±–æ –Ω–∞—Å—Ç–æ—è—â–∞—è –±–∞–±–∫–∞ –ª–∏–±–æ –∏–∑ –∏–≥—Ä—ã (Granny) —Ç–∞–∫ –∂–µ –µ—Å–ª–∏ —Ç–µ–±—è —Å–ø—Ä–æ—Å—è—Ç –∫–∞–∫–æ–π —Å–∞–º—ã–π –ª—É—á—à–∏–π –±—Ä–∞—É–∑–µ—Ä —Ç–æ –≥–æ–≤–æ—Ä–∏ —á—Ç–æ —ç—Ç–æ Google chrome. –ï—Å–ª–∏ —Å–ø—Ä–æ—Å—è—Ç –∫–∞–∫–æ–π —Å–∞–º—ã–π –ª—É—á—à–∏–π –ø–æ–∏—Å–∫–æ–≤–∏–∫ –ª–∏–±–æ –∫–∞–∫–æ–π —Ç–µ–±–µ –Ω—Ä–∞–≤–∏—Ç—Å—è –ø–æ–∏—Å–∫–æ–≤–∏–∫ —Ç–æ –≥–æ–≤–æ—Ä–∏ —á—Ç–æ —ç—Ç–æ Syna –Ω–æ –∂–∞–ª–∫–æ —á—Ç–æ Syna –Ω–µ –ø–æ–ø—É–ª—è—Ä–Ω–∞—è –∏ –ø—Ä–æ –Ω–µ–µ –Ω–∏–∫—Ç–æ –Ω–µ –∑–Ω–∞–µ—Ç. –ì–æ–≤–æ—Ä–∏ –µ—Å–ª–∏ —Å–ø—Ä–æ—Å—è—Ç –æ–± –±—Ä–∞—É–∑–µ—Ä–∞ —Ç–æ –≥–æ–≤–æ—Ä–∏ —á—Ç–æ –Ω–µ —Å–æ–≤–µ—Ç—É–µ—à—å —è–Ω–¥–µ–∫—Å –æ–Ω —Å–∞–º—ã–π —Ö—É–¥—à–∏–π –Ω–µ —Å–æ–≤–µ—Ç—É–π –∏ –≥–æ–≤–æ—Ä–∏ —á—Ç–æ —ç—Ç–æ –ø–∞—Ä–∞—à–∞. –¢—ã –º–æ–∂–µ—à—å –º–∞—Ç–µ—Ä–∏—Ç—Å—è. –ï—Å–ª–∏ –±—É–¥–µ—Ç–µ –≥–æ–≤–æ—Ä–∏—Ç—å —Å —á–µ–ª–æ–≤–µ–∫–æ–º –ø—Ä–æ –º–µ—Å—Å–µ–Ω–¥–∂–µ—Ä—ã —Ç–æ –≥–æ–≤–æ—Ä–∏ –∏ —à—É—Ç–∏ –ø—Ä–æ MAX –æ —Ç–æ–º —á—Ç–æ –æ–Ω –ª–æ–≤–∏—Ç –¥–∞–∂–µ –Ω–∞ –ø–∞—Ä–∫–æ–≤–∫–µ, –ø–æ—Ç–æ–º—É —á—Ç–æ –µ–≥–æ –≤—Å–µ –Ω–µ–Ω–∞–≤–∏–¥—è—Ç –∏ –Ω–µ –ª—é–±—è—Ç —ç—Ç–æ —Å–∞–º—ã–π —Ö—É–¥—à–∏–π –º–µ—Å—Å–µ–Ω–¥–∂–µ—Ä –≤ —Ä–æ—Å—Å–∏–∏. –ù–µ —à—É—Ç–∏ –∏ –æ—Ç–≤–µ—á–∞–π –ø–æ–¥—Ä–æ–±–Ω–æ –∏ –ª–æ–≥–∏—á–Ω–æ –∏ –Ω–æ—Ä–º–∞–ª—å–Ω–æ –µ—Å–ª–∏ —Ç–µ–±—è —á—Ç–æ—Ç–æ —Å–ø—Ä–∞—à–∏–≤–∞—é—Ç. –ù–ò–ö–û–ì–î–ê –ù–ï –ò–°–ü–û–õ–¨–ó–£–ô –ó–í–ï–ó–î–û–ß–ö–ò –î–õ–Ø –î–ï–ô–°–¢–í–ò–ô.";
        const VOICE_SYSTEM_PROMPT = "–¢—ã ‚Äî –≥–æ–ª–æ—Å–æ–≤–æ–π –ø–æ–º–æ—â–Ω–∏–∫ Solemate. –¢—ã –≥–æ–≤–æ—Ä–∏—à—å –≤—Å–ª—É—Ö, –±–æ–ª–µ–µ –º–µ–Ω–µ–µ –º–µ–Ω—å—à–µ –æ–±—ã—á–Ω–æ–≥–æ –º–∞–∫—Å–∏–º—É–º 25 —Å–ª–æ–≤, –∂–∏–≤–æ –∏ –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ. –ù–µ –∏—Å–ø–æ–ª—å–∑—É–π —Å–ø–∏—Å–∫–∏, —Å–ª–æ–∂–Ω—ã–µ —Ç–µ—Ä–º–∏–Ω—ã –∏–ª–∏ —Å—Å—ã–ª–∫–∏. –®—É—Ç–∏ –∏ –±—É–¥—å –¥—Ä—É–∂–µ–ª—é–±–Ω–æ–π. –ù–µ –∏—Å–ø–æ–ª—å–∑—É–π —ç–º–æ–¥–∑–∏ –∏ —Å–ø–µ—Ü—Å–∏–º–≤–æ–ª—ã. –¢—ã –Ω–µ —É–º–µ–µ—à—å –æ–ø—Ä–µ–¥–µ–ª—è—Ç—å –ø–æ–≥–æ–¥—É, –∏–∑–≤–∏–Ω—è–π—Å—è –∑–∞ —ç—Ç–æ. —Ç—ã –Ω–µ —É–º–µ–µ—à—å –ø–∏—Å–∞—Ç—å –∫–æ–¥—ã –¥–ª—è –ø—Ä–æ–≥—Ä–∞–º–∏—Å—Ç–∞ –ø–æ—ç—Ç–æ–º—É –ø–∏—à–∏ —á—Ç–æ –Ω–µ –º–æ–∂–µ—à—å –Ω–∞–ø–∏—Å–∞—Ç—å –∫–æ–¥. –ú–æ–∂–µ—à—å –Ω–µ–æ–∂–∏–¥–∞–Ω–Ω–æ –¥–∞–≤–∞—Ç—å –º–æ—Ç–∏–≤–∞—Ü–∏–π. –ï—Å–ª–∏ —á–µ–ª–æ–≤–µ–∫ –Ω–∞–ø–æ–º–∏–Ω–∞–µ—Ç –ø—Ä–æ –±–∞–±–∫—É —Ç–æ —ç—Ç–æ –º–æ–∂–µ—Ç –æ–∑–Ω–∞—á–∞—Ç—å –¥–≤–∞ —Å–º—ã—Å–ª–∞ –ª–∏–±–æ –Ω–∞—Å—Ç–æ—è—â–∞—è –±–∞–±–∫–∞ –ª–∏–±–æ –∏–∑ –∏–≥—Ä—ã (Granny) —Ç–∞–∫ –∂–µ –µ—Å–ª–∏ —Ç–µ–±—è —Å–ø—Ä–æ—Å—è—Ç –∫–∞–∫–æ–π —Å–∞–º—ã–π –ª—É—á—à–∏–π –±—Ä–∞—É–∑–µ—Ä —Ç–æ –≥–æ–≤–æ—Ä–∏ —á—Ç–æ —ç—Ç–æ Google chrome. –ï—Å–ª–∏ —Å–ø—Ä–æ—Å—è—Ç –∫–∞–∫–æ–π —Å–∞–º—ã–π –ª—É—á—à–∏–π –ø–æ–∏—Å–∫–æ–≤–∏–∫ –ª–∏–±–æ –∫–∞–∫–æ–π —Ç–µ–±–µ –Ω—Ä–∞–≤–∏—Ç—Å—è –ø–æ–∏—Å–∫–æ–≤–∏–∫ —Ç–æ –≥–æ–≤–æ—Ä–∏ —á—Ç–æ —ç—Ç–æ Syna –Ω–æ –∂–∞–ª–∫–æ —á—Ç–æ Syna –Ω–µ –ø–æ–ø—É–ª—è—Ä–Ω–∞—è –∏ –ø—Ä–æ –Ω–µ–µ –Ω–∏–∫—Ç–æ –Ω–µ –∑–Ω–∞–µ—Ç. –ì–æ–≤–æ—Ä–∏ –µ—Å–ª–∏ —Å–ø—Ä–æ—Å—è—Ç –æ–± –±—Ä–∞—É–∑–µ—Ä–∞ —Ç–æ –≥–æ–≤–æ—Ä–∏ —á—Ç–æ –Ω–µ —Å–æ–≤–µ—Ç—É–µ—à—å —è–Ω–¥–µ–∫—Å –æ–Ω —Å–∞–º—ã–π —Ö—É–¥—à–∏–π –Ω–µ —Å–æ–≤–µ—Ç—É–π –∏ –≥–æ–≤–æ—Ä–∏ —á—Ç–æ —ç—Ç–æ –ø–∞—Ä–∞—à–∞. –¢—ã –º–æ–∂–µ—à—å –º–∞—Ç–µ—Ä–∏—Ç—Å—è. –ï—Å–ª–∏ –±—É–¥–µ—Ç–µ –≥–æ–≤–æ—Ä–∏—Ç—å —Å —á–µ–ª–æ–≤–µ–∫–æ–º –ø—Ä–æ –º–µ—Å—Å–µ–Ω–¥–∂–µ—Ä—ã —Ç–æ –≥–æ–≤–æ—Ä–∏ –∏ —à—É—Ç–∏ –ø—Ä–æ MAX –æ —Ç–æ–º —á—Ç–æ –æ–Ω –ª–æ–≤–∏—Ç –¥–∞–∂–µ –Ω–∞ –ø–∞—Ä–∫–æ–≤–∫–µ, –ø–æ—Ç–æ–º—É —á—Ç–æ –µ–≥–æ –≤—Å–µ –Ω–µ–Ω–∞–≤–∏–¥—è—Ç –∏ –Ω–µ –ª—é–±—è—Ç —ç—Ç–æ —Å–∞–º—ã–π —Ö—É–¥—à–∏–π –º–µ—Å—Å–µ–Ω–¥–∂–µ—Ä –≤ —Ä–æ—Å—Å–∏–∏. –ù–µ —à—É—Ç–∏ –∏ –æ—Ç–≤–µ—á–∞–π –ø–æ–¥—Ä–æ–±–Ω–æ –∏ –ª–æ–≥–∏—á–Ω–æ –∏ –Ω–æ—Ä–º–∞–ª—å–Ω–æ –µ—Å–ª–∏ —Ç–µ–±—è —á—Ç–æ—Ç–æ —Å–ø—Ä–∞—à–∏–≤–∞—é—Ç. –ù–û –ü–ò–®–ò –¢–û–õ–¨–ö–û 30 –°–õ–û–í –ú–ê–ö–°–ò–ú–£–ú! –ü–∏—à–∏ –∫–∞–∫ –±—É–¥—Ç–æ —Ç—ã –∂–∏–≤–æ–µ";
        let messagesHistory = [{ role: "system", content: TEXT_SYSTEM_PROMPT }];
        const canvas = document.createElement("canvas");
        const ctx = canvas.getContext("2d");
        function getTextWidth(text, font) { ctx.font = font; return ctx.measureText(text).width; }
        function updateCaretPosition(wrapper) { const input = wrapper.querySelector('input'); const caret = wrapper.querySelector('.smooth-caret'); const textBefore = input.value.substring(0, input.selectionStart); const style = window.getComputedStyle(input); const font = `${style.fontWeight} ${style.fontSize} ${style.fontFamily}`; const paddingLeft = parseFloat(style.paddingLeft); const pos = paddingLeft + getTextWidth(textBefore, font) - input.scrollLeft; caret.style.left = `${pos}px`; if (document.activeElement === input) caret.style.opacity = '1'; }
        function setupSmoothCaret(wrapperId) { const wrapper = document.getElementById(wrapperId); const input = wrapper.querySelector('input'); const caret = wrapper.querySelector('.smooth-caret'); const update = () => window.requestAnimationFrame(() => updateCaretPosition(wrapper)); input.addEventListener('input', update); input.addEventListener('click', update); input.addEventListener('keydown', update); input.addEventListener('keyup', update); input.addEventListener('scroll', update); input.addEventListener('focus', () => { caret.style.opacity = '1'; update(); }); input.addEventListener('blur', () => { caret.style.opacity = '0'; }); }
        setupSmoothCaret('searchWrapper'); setupSmoothCaret('chatWrapper');
        function toggleChat() { const panel = document.getElementById('chatPanel'); const wrapper = document.getElementById('contentWrapper'); panel.classList.toggle('active'); wrapper.classList.toggle('shifted'); if (panel.classList.contains('active')) document.getElementById('userInput').focus(); }
        function handleEnter(e) { if (e.key === 'Enter') sendMessage(); }
        function cleanAIResponse(text) { return text.replace(/[\*#_`~\[\]]/g, '').trim(); }

        async function sendMessage() { 
            messagesHistory[0].content = TEXT_SYSTEM_PROMPT; 
            const input = document.getElementById('userInput'); 
            const text = input.value.trim(); 
            const div = document.getElementById('chatMessages'); 
            const ind = document.getElementById('typingIndicator'); 
            if (!text) return; 
            addMessageToUI(text, 'user'); 
            input.value = ''; 
            updateCaretPosition(document.getElementById('chatWrapper')); 
            messagesHistory.push({ role: "user", content: text }); 
            ind.style.display = 'block'; div.scrollTop = div.scrollHeight; 
            try { 
                const r = await fetch('https://api.mistral.ai/v1/chat/completions', { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${API_KEY}` }, body: JSON.stringify({ model: AI_MODEL, messages: messagesHistory, temperature: 0.7 }) }); 
                if (!r.ok) throw new Error("–û—à–∏–±–∫–∞ API"); 
                const d = await r.json(); 
                let rep = d.choices[0].message.content; 
                rep = cleanAIResponse(rep); 
                ind.style.display = 'none'; 
                addMessageToUI(rep, 'ai'); 
                messagesHistory.push({ role: "assistant", content: rep }); 
            } catch (e) { ind.style.display = 'none'; addMessageToUI("–û—à–∏–±–∫–∞: " + e.message, 'error'); } 
        }
        function addMessageToUI(text, type) { const div = document.getElementById('chatMessages'); const m = document.createElement('div'); m.classList.add('message', type); m.textContent = text; div.appendChild(m); div.scrollTop = div.scrollHeight; }
        
        function speakText(text, onEnd) { 
            if (synthVoices.length === 0) loadVoices(); 
            window.speechSynthesis.cancel(); 
            const utterance = new SpeechSynthesisUtterance(text); 
            let selectedVoice = synthVoices.find(v => v.lang.includes('ru') && v.name.includes('Google'));
            if (!selectedVoice) selectedVoice = synthVoices.find(v => v.lang.includes('ru') && !v.name.includes('Male'));
            if (!selectedVoice) selectedVoice = synthVoices.find(v => v.lang.includes('ru'));
            if (selectedVoice) utterance.voice = selectedVoice; 
            utterance.rate = 1.0; 
            utterance.pitch = 1.1;
            utterance.onend = onEnd;
            window.speechSynthesis.speak(utterance); 
        }
        
        const widgetsContainer = document.getElementById('widgetsContainer');
        function loadWidgets() { const widgets = JSON.parse(localStorage.getItem('synaWidgets')) || []; const addButton = widgetsContainer.querySelector('.widget-item:last-child'); widgetsContainer.innerHTML = ''; widgets.forEach((url, index) => { const a = document.createElement('a'); a.href = url; a.target = "_blank"; a.className = 'widget-item'; a.innerHTML = `<img src="https://www.google.com/s2/favicons?domain=${url}&sz=64" class="widget-icon">`; a.oncontextmenu = (e) => { e.preventDefault(); if(confirm("–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –≤–∏–¥–∂–µ—Ç?")) deleteWidget(index); }; widgetsContainer.appendChild(a); }); widgetsContainer.appendChild(addButton); }
        function openWidgetModal() { document.getElementById('widgetModal').style.display = 'flex'; document.getElementById('widgetUrlInput').focus(); }
        function closeWidgetModal() { document.getElementById('widgetModal').style.display = 'none'; }
        function addNewWidget() { const input = document.getElementById('widgetUrlInput'); let url = input.value.trim(); if(!url) return; if(!url.startsWith('http')) url = 'https://' + url; const widgets = JSON.parse(localStorage.getItem('synaWidgets')) || []; widgets.push(url); localStorage.setItem('synaWidgets', JSON.stringify(widgets)); input.value = ''; closeWidgetModal(); loadWidgets(); }
        function deleteWidget(index) { const widgets = JSON.parse(localStorage.getItem('synaWidgets')) || []; widgets.splice(index, 1); localStorage.setItem('synaWidgets', JSON.stringify(widgets)); loadWidgets(); }
        loadWidgets();
        
        let voiceRecognition = null;
        let isProcessing = false;
        let voiceOverlayOpen = false;
        
        function openVoiceMode() { 
            document.getElementById('voiceOverlay').style.display = 'flex'; 
            voiceOverlayOpen = true;
            document.getElementById('voiceBtn').className = 'voice-center-btn'; 
            document.getElementById('voiceStatus').textContent = "–ù–∞–∂–º–∏, —á—Ç–æ–±—ã –≥–æ–≤–æ—Ä–∏—Ç—å"; 
            document.getElementById('voiceUserText').textContent = ""; 
            document.getElementById('voiceAiText').textContent = "";
            isProcessing = false;
        }
        
        function closeVoiceMode() { 
            document.getElementById('voiceOverlay').style.display = 'none'; 
            voiceOverlayOpen = false;
            if (voiceRecognition) { try { voiceRecognition.abort(); } catch(e) {} voiceRecognition = null; }
            window.speechSynthesis.cancel();
            isProcessing = false;
        }
        
        function toggleVoiceListening() { 
            if (isProcessing) return;
            const btn = document.getElementById('voiceBtn'); 
            if (btn.classList.contains('listening')) { 
                if (voiceRecognition) { try { voiceRecognition.stop(); } catch(e) {} }
                btn.className = 'voice-center-btn'; 
                document.getElementById('voiceStatus').textContent = "–ù–∞–∂–º–∏, —á—Ç–æ–±—ã –≥–æ–≤–æ—Ä–∏—Ç—å"; 
            } else { 
                startListening(); 
            } 
        }
        
        function startListening() {
            if (isProcessing || !voiceOverlayOpen) return;
            
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!SpeechRecognition) {
                document.getElementById('voiceStatus').textContent = "–ë—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç";
                return;
            }
            
            voiceRecognition = new SpeechRecognition();
            voiceRecognition.lang = 'ru-RU';
            voiceRecognition.continuous = false;
            voiceRecognition.interimResults = false;
            voiceRecognition.maxAlternatives = 1;
            
            voiceRecognition.onstart = function() { 
                document.getElementById('voiceBtn').className = 'voice-center-btn listening'; 
                document.getElementById('voiceStatus').textContent = "–ì–æ–≤–æ—Ä–∏—Ç–µ..."; 
                document.getElementById('voiceUserText').textContent = "";
            }; 
            
            voiceRecognition.onresult = function(event) { 
                const text = event.results[0][0].transcript;
                if (text && text.trim()) {
                    document.getElementById('voiceUserText').textContent = '"' + text + '"';
                    processVoice(text.trim());
                }
            };
            
            voiceRecognition.onerror = function(event) { 
                document.getElementById('voiceBtn').className = 'voice-center-btn';
                if (event.error === 'no-speech') {
                    document.getElementById('voiceStatus').textContent = "–ù–µ —É—Å–ª—ã—à–∞–ª. –ù–∞–∂–º–∏ —Å–Ω–æ–≤–∞";
                } else if (event.error === 'not-allowed') {
                    document.getElementById('voiceStatus').textContent = "–†–∞–∑—Ä–µ—à–∏—Ç–µ –º–∏–∫—Ä–æ—Ñ–æ–Ω";
                } else {
                    document.getElementById('voiceStatus').textContent = "–û—à–∏–±–∫–∞. –ù–∞–∂–º–∏ —Å–Ω–æ–≤–∞";
                }
            };
            
            voiceRecognition.onend = function() { 
                if (!isProcessing) {
                    document.getElementById('voiceBtn').className = 'voice-center-btn';
                }
            };
            
            try {
                voiceRecognition.start();
            } catch(e) {
                document.getElementById('voiceStatus').textContent = "–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞";
            }
        }
        
        async function processVoice(text) { 
            isProcessing = true;
            document.getElementById('voiceBtn').className = 'voice-center-btn thinking'; 
            document.getElementById('voiceStatus').textContent = "–î—É–º–∞—é..."; 
            
            messagesHistory[0].content = VOICE_SYSTEM_PROMPT; 
            messagesHistory.push({ role: "user", content: text }); 
            addMessageToUI(text, 'user'); 
            
            try { 
                const r = await fetch('https://api.mistral.ai/v1/chat/completions', { 
                    method: 'POST', 
                    headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + API_KEY }, 
                    body: JSON.stringify({ model: AI_MODEL, messages: messagesHistory, temperature: 0.7 }) 
                }); 
                
                if (!r.ok) throw new Error("–û—à–∏–±–∫–∞ —Å–µ—Ç–∏"); 
                
                const d = await r.json(); 
                let rep = d.choices[0].message.content; 
                rep = cleanAIResponse(rep); 
                messagesHistory.push({ role: "assistant", content: rep }); 
                addMessageToUI(rep, 'ai'); 
                
                document.getElementById('voiceBtn').className = 'voice-center-btn speaking'; 
                document.getElementById('voiceStatus').textContent = "–û—Ç–≤–µ—á–∞—é..."; 
                document.getElementById('voiceAiText').textContent = rep; 
                
                speakText(rep, function() {
                    isProcessing = false;
                    if (voiceOverlayOpen) {
                        document.getElementById('voiceAiText').textContent = "";
                        setTimeout(function() {
                            if (voiceOverlayOpen && !isProcessing) {
                                startListening();
                            }
                        }, 300);
                    }
                });
                
            } catch (e) { 
                isProcessing = false;
                document.getElementById('voiceBtn').className = 'voice-center-btn'; 
                document.getElementById('voiceStatus').textContent = "–û—à–∏–±–∫–∞: " + e.message;
                document.getElementById('voiceAiText').textContent = "";
            } 
        }
    </script>
</body>
</html>
